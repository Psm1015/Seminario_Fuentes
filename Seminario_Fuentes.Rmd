---
title: "Relación de la obesidad con el desempleo y la alimentación"
author: "Diego González Sánchez, Pablo Santamaría Miguel, Juan Hernando Quintana"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **Índice**
  1. URL repositorio GitHub
  2. Datos utilizados
  3. Introducción 
  4. Objetivo general
  5. Paquetes utilizados
  6. Manipulación de datos
  7. Importación de datos
  8. Análisis de datos
  9. Resultados
  10. Conclusiones
  11. Referencias

## **1. URL repositorio GitHub**
https://github.com/Psm1015/Seminario_Fuentes.git

## **2. Datos utilizados**
En este apartado es donde se indican las URL´s que se van a utilizar durante el desarrollo de este proyecto. 

- [Datos obesidad](https://datos.gob.es/es/catalogo/ea0010587-indice-de-masa-corporal-poblacion-adulta-segun-sexo-grupo-de-edad-y-nivel-de-estudios-poblacion-de-18-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-01005-px1)

- [Datos desempleo](https://datos.gob.es/es/catalogo/ea0010587-parados-por-tiempo-de-busqueda-de-empleo-sexo-y-grupo-de-edad-epa-identificador-api-66002)

- [Datos alimentación](https://datos.gob.es/es/catalogo/ea0010587-patron-de-consumo-de-determinados-alimentos-segun-sexo-y-grupo-de-edad-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-05001-px1)

## **3. Introducción**
La obesidad es una enfermedad crónica común que se caracteriza por una acumulación anormal de grasa en el cuerpo, que no es saludable.

Aunque existen influencias genéticas, conductuales, metabólicas y hormonales en el peso corporal, la obesidad ocurre cuando se ingieren más calorías de las que se queman con las actividades diarias típicas y el ejercicio. El cuerpo almacena ese exceso de calorías en forma de grasa.

En este caso se realizará un estudio de como se ve afectada la obesidad en relación con el desempleo y la alimentación  respecto a la edad.

## **4. Objetivo general**
• Relación entre la obesidad, nivel de estudios, sexo y edad.

• Relación entre desempleo y obesidad.

• Relación entre alimentación y rangos de edad.

## **5. Paquetes utilizados**
Explícación de las distintas librerias utilizadas durante el desarrollo del proyecto:

**1. library(dplyr)**

Dplyr nos permite seleccionar, modificar, filtrar y agrupar los datos con los que hemos trabajado de forma sencilla.

```{r , eval = TRUE, warning = FALSE, message=FALSE}
library(dplyr)
```

**2. library(tidyverse)**

Utilizamos tidyverse para importar, transformar y manipular los datos con los que trabajamos.

```{r , eval = TRUE, warning = FALSE, message=FALSE}
library(tidyverse)
```

**3. library(pxR)**

Nos permite leer y manipular acrhivos que se encuentran en formato pc axis.

```{r , eval = TRUE, warning = FALSE, message=FALSE}
library(pxR)
```

**4. library(DT)**

Utilizamos esta librería para mostrar tablas de datos.
```{r , eval = TRUE, warning = FALSE, message=FALSE}
library(DT)
```

**5. library(ggplot2)**

Utilizamos esta librería para representar mediante gráficos los datos.

```{r , eval = TRUE, warning = FALSE, message=FALSE}
library(ggplot2)
```


## **6. Manipulación de datos**
Los archivox .px son un formato estándar para almacenar datos estadísticos en forma de tablas multidimensionales.

**Nota: ** 
Iniciálmente nuestros datos px no se encontraban en una codificacion UTF-8 y nos daba problemas al intentar visualizar los datos al inicio ya que contienen carácteres extraños como la 'ñ'.
Para solucionar nuestro problema hemos recurrido a la ayuda de chatgpt utlizando el siguiente prompt:

Estoy tratando de leer un archivo pc axis en rstudio y me da distintos errores al intntar leerlo. 
Quiero que me propongas una solución para poder leer el archivo

La IA nos sugirió que convirtiesemos la codificación de nuestros archivos, los cuales estaban en 'ISO-8859-1' a la codificación 'UTF-8'.
De esta forma ya podiamos visualizar y manipular nuestros datos.
Para ello realizamos lo siguiente (hemos tomado como ejemplo el archivo de Desempleo.px pero se realiza de la misma forma en todos los archivos .px):

Primero leemos nuestro archivo línea por línea en la codificación "ISO-8859-1"
```{r , eval = TRUE, warning = FALSE}
#Lectura del archivo línea por línea
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")
```

A continuación modificamos la codificación original de nuestro archivo a la codificación "UTF-8"
```{r , eval = TRUE, warning = FALSE}
#Modifica la codificación original del texto a la codificación UTF-8
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")
```

Ahora realizamos la creación del archivo temporal .px dentro de nuestro entorno
```{r , eval = TRUE, warning = FALSE}
#Creación del archivo temporal .px
archivo_utf8 <- tempfile(fileext = ".px")
```

Escribimos el contenido codificado en UTF-8 al archivo temporal
```{r , eval = TRUE, warning = FALSE}
#Se escribe el contenido codificado en UTF-8 al archivo temporal
writeLines(archivo_texto_utf8, archivo_utf8)
```

Y por último leemos este archivo temporal
```{r , eval = TRUE, warning = FALSE}
# Lee el archivo temporal con read.px
datos <- read.px(archivo_utf8)
```


## **7. Importación de datos**
En este apartado, se proporciona el código necesario para importar los archivos pc-axis de IMC, alimentación y desempleo

- IMC
```{r , eval = TRUE, warning = FALSE}
IMC <- readLines("INPUT/DATA/Indice-masa-corporal.px", encoding = "ISO-8859-1")
IMC_utf8 <- iconv(IMC, from = "ISO-8859-1", to = "UTF-8")
```

- Alimentación
```{r , eval = TRUE, warning = FALSE}
Alimentacion <- readLines("INPUT/DATA/Alimentacion.px", encoding = "ISO-8859-1")
Alimentacion_utf8 <- iconv(Alimentacion, from = "ISO-8859-1", to = "UTF-8")
```

```{r , eval = TRUE, warning = FALSE}
archivo_Alimentacion <- tempfile(fileext = ".px")
writeLines(Alimentacion_utf8, archivo_Alimentacion)

# Lee el archivo temporal con read.px
Alimentacion_datos<- read.px(archivo_Alimentacion)
```

- Desempleo
```{r , eval = TRUE, warning = FALSE}
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")
```

## **8. Análisis de datos**
En el archvido desempleo trabajaremos solo con los datos obtenidos del año 2021 en función del tiempo de búsqueda de empleo.

En el archivo alimentación analizaremos las distintas frecuencias con las que las personas del mismo rango de edades anterior consumen carne, pescado, dulces etc

En el archivo IMC (indice de masa corporal) estudiaremos el peso corporal de las personas según su nivel de estudios.

En todos ellos trabajaremos con unos rangos de edades de 8 a 24 años, 25 a 64 años y de 65 o más años.
Debido a como estaban estructurados los datos solo hemos tenido que establecer los rangos de edades en Alimentación y desempleo.

### **8.1 IMC**
Una vez tenemos los datos cargados, hemos tenido que realizar una serie de modificaciones para que sean aptos para trabajar con ellos.

#### **8.1.1** Lectura del archivo

Una vez tenemos cargados los archivos, necesitamos leerlos.

```{r , eval = TRUE, warning = FALSE}

#Crea un archivo temporal con extensión px.
archivo_temp_IMC <- tempfile(fileext = ".px")

#Para escribir el contenido de IMC_utf8 en el archivo temporal.
writeLines(IMC_utf8, archivo_temp_IMC)

# Lee el archivo temporal con read.px
datos_IMC <- read.px(archivo_temp_IMC)
```


#### **8.1.2** Conversión a DATAFRAME y eliminación de caracteres incorrectos
Almacenamos los datos en un dataframe y modificamos los valores de las columnas que tenían caracteres especiales.

```{r , eval = TRUE, warning = FALSE}
DF_mal <- as.data.frame(datos_IMC)

DF <- DF_mal %>%
  transmute(
    Masa.corporal.adultos = Masa.corporal.adultos,
    Nivel.de.estudios = factor(case_when(
      Nivel.de.estudios == "TOTAL" ~ "TOTAL",
      Nivel.de.estudios == "BÃ¡sico e inferior" ~ "Básico e inferior",
      Nivel.de.estudios == "Intermedio" ~ "Intermedio",
      Nivel.de.estudios == "Superior" ~ "Superior",
    )),
    Edad = factor(case_when(
      Edad == "TOTAL" ~ "TOTAL",
      Edad == "De 18 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 y mÃ¡s aÃ±os" ~ "De 65 y más años",
    )),
    Sexo = Sexo,
    Porcentaje.personas = value
  )
```

#### **8.1.3** Eliminación de datos que no necesitamos
Eliminamos todos los datos del dataframe que no nos vana  ser útiles.

```{r , eval = TRUE, warning = FALSE}
datos_IMC_df <- DF %>%
  filter(
    Masa.corporal.adultos != "TOTAL",    
    Sexo != "Ambos sexos",                                  
    Edad != "TOTAL",                                        
    Nivel.de.estudios != "TOTAL"                            
  )
```


#### **8.1.4** Eliminación de niveles
Eliminamos los niveles de las columnas que no vamos a utilizar para evitar posibles errores al crear las gráficas.

```{r , eval = TRUE, warning = FALSE}
datos_IMC_df$Sexo <- droplevels(datos_IMC_df$Sexo)
datos_IMC_df$Nivel.de.estudios <- droplevels(datos_IMC_df$Nivel.de.estudios)
datos_IMC_df$Edad <- droplevels(datos_IMC_df$Edad)
datos_IMC_df$Masa.corporal.adultos <- droplevels(datos_IMC_df$Masa.corporal.adultos)

```

#### **8.1.5** Creación de datos de obesidad.

Creamos unos datos específicos de obesidad para facilitar la creación de determinadas gráficas.

```{r , eval = TRUE, warning = FALSE}

datos_obesidad <- datos_IMC_df %>%
  filter(
    Masa.corporal.adultos == "Obesidad (IMC>=30 kg/m2)",    
  )
```

#### **8.1.6** Datos necesarios para la gráfica de diferentes pesos.

Datos que van a ser necesarios para crear la gráfica que compara los diferentes pesos.
```{r , eval = TRUE, warning = FALSE}
IMC_grafica1<- datos_IMC_df %>%
  group_by(Masa.corporal.adultos) %>%
  dplyr::summarise(Porcentaje.personas = mean(Porcentaje.personas, na.rm = TRUE))
```

#### **8.1.7** Datos necesarios para la gráfica de obesidad.

```{r , eval = TRUE, warning = FALSE}
media_por_grupo <- datos_obesidad %>%
  group_by(Nivel.de.estudios, Sexo, Edad) %>%
  dplyr::summarise(media_porcentaje = mean(Porcentaje.personas, na.rm = TRUE))
```

### **8.2 Alimentación**

Comenzamos creando un dataframe para ver los datos de nuestro archivo de alimentación

```{r , eval = TRUE, warning = FALSE}
DF <- as.data.frame(Alimentacion_datos)
datatable(DF)
```

#### **8.2.1 Rangos de edades y corrección de carácteres extraños**
A continuación, se filtran diversos rangos de edad para la adaptación de los datos de este archivo con los demás set de datos.
```{r , eval = TRUE, warning = FALSE}
# Filter para quitar diversos rangos de edad
DF1 <- DF %>%
  filter(!(Edad %in% c("De 25 a 34 aÃ±os", "De 45 a 54 aÃ±os", "De 55 a 64 aÃ±os", "De 75 y mÃ¡s aÃ±os")))
datatable(DF1)
```

Además se cambian los nombres de las de la columna __Edad__, __Frecuencia__ y __Alimentos__(caracteres extraños). Para ello utilizamos un __transmute__.
```{r , eval = TRUE, warning = FALSE}
# Cambios en las filas de la columna Edad, Frecuencia y Alimentos.
datos_df1 <- DF1 %>%
  transmute(
    Edad = case_when(
      Edad == "De 15 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 35 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 74 aÃ±os" ~ "De 65 y más años",
    ),
    Frecuencia = case_when(
      Frecuencia == "3 o mÃ¡s veces a la semana pero no a diario" ~ "3 o más veces a la semana pero no a diario",
      Frecuencia == "Menos de 1 vez a la semana" ~ "Menos de 1 vez a la semana",
      Frecuencia == "1 o 2 veces a la semana" ~ "1 o 2 veces a la semana",
      Frecuencia == "A diario" ~ "A diario",
      Frecuencia == "TOTAL" ~ "TOTAL",
      Frecuencia == "Nunca" ~ "Nunca"
    ),
    Alimentos = case_when(
      Alimentos == "Fruta fresca (excluye zumos)" ~ "Fruta fresca (excluye zumos)",
      Alimentos == "Carne" ~ "Carne",
      Alimentos == "Huevos" ~ "Huevos",
      Alimentos == "Pescado" ~ "Pescado",
      Alimentos == "Pasta,arroz,patatas" ~ "Pasta,arroz,patatas",
      Alimentos == "Pan,cereales" ~ "Pan,cereales",
      Alimentos == "Verduras, ensaladas y hortalizas" ~ "Verduras, ensaladas y hortalizas",
      Alimentos == "Legumbres" ~ "Legumbres",
      Alimentos == "Embutidos y fiambres" ~ "Embutidos y fiambres",
      Alimentos == "Productos lÃ¡cteos" ~ "Productos lácteos",
      Alimentos == "Dulces" ~ "Dulces",
      Alimentos == "Refrescos con azÃºcar" ~ "Refrescos con azúcar",
      Alimentos == "Comida rÃ¡pida" ~ "Comida rápida",
      Alimentos == "Aperitivos o comidas saladas de picar" ~ "Aperitivos o comidas saladas de picar",
      Alimentos == "Zumo natural de frutas o verduras" ~ "Zumo natural de frutas o verduras"
    ),
    Sexo = Sexo,
    value = value
  )
```

#### **8.2.2 Eliminación de los valores NA**
Que aparezcan valores nulos en la tabla no es una buena condicón para poder trabajar con estos datos. Por ello se van a eliminar estos valores con la función **drop_na()** que elimina todos las líneas en la que alguna de sus columnas tenga el valor NA.
```{r , eval = TRUE, warning = FALSE}
# ELIMINAR TODAS LAS FILAS QUE TENGAN NA
df_sin_NA <- datos_df1 %>% 
  drop_na()
datatable(df_sin_NA)
```

#### **8.2.3 Eliminación de valores inecesarios**
De la tabla anterior, los valores que corresponden a Total de la columna __Frecuencia__ no nos aportan ningún tipo de información adicional, por ello se eliminan utilizando la función **filter()**
```{r , eval = TRUE, warning = FALSE}
# ELIMINAR FRECUENCIA TOTAL
datos_Alimentacion <-  df_sin_NA%>%
  filter(
    Frecuencia != "TOTAL",                                
  )
```

#### **8.2.4 Relación del tipo de alimentación a diario por rangos de edad**
Como existe muchos tipos de comida, se seleccionan los más importante. Para ello, se utiliza la función **filter**.
```{r , eval = TRUE, warning = FALSE}
Alimentacion_ADiario <- datos_Alimentacion %>%
  filter(
    Frecuencia == "A diario",
    (!(Alimentos %in% c("Aperitivos o comidas saladas de picar", "Zumo natural de frutas o verduras")))
  )
datatable(Alimentacion_ADiario)
```

Este filter elimina de __datos_Alimentacion__ los siguientes alimentos:

• Aperitivos o comidas saladas de picar.

• Zumo natural de frutas o verduras.

Como ya tenemos eliminados algunos alimentos se procede a crear una gráfica para ver cómo afecta la edad al tipo de alimenación
```{r, echo = TRUE}
Grafica_AlimentosXDia <- ggplot(data = Alimentacion_ADiario, aes(x = Edad, y = value)) +
  geom_bar(aes(fill = Alimentos), position = "dodge", stat = "identity")
Grafica_AlimentosXDia
```

En esta gráfica se puede observar que en el rango de edad entre 18 y 25 años el alimento que más se consume proviene de productos lácteos, como puede ser el queso o la propia leche, seguido del pan y cereales. Por otro lado el producto que menos se consume en este rango de edad es el pescado.

En segundo lugar, observando el rango entre 25 y 64 años se observa que las preferencias son las mismas que en el anterior rango de edad pero hay un incremento en el consumo de verduras, hortalizas y ensaladas, y de fruta fresca.

Por último, indicar que a partir de los 65 años sigue aumentando el consumo de fruta fresca.

Un dato importante es que a el consumo de refrescos con azúcar va disminuyendo con la edad.

#### **8.2.5 Relación de la alimentación de pescado y carne 3 o más veces a la semana pero no a diario por rango de edad y sexo**
En este apartado vamos a analizar a la vez la relación del pescado y de la carne por la frecuencia indicada, por edad y sexo.

Para poder observar bien la gráfica hay que coger solo la frecuencia indicada y el alimento indicado para esto es necesario utilizar un filter
```{r, eval = TRUE, warning = FALSE}
Alimentacion_pescado <- datos_Alimentacion %>%
  filter(
    Frecuencia == "3 o más veces a la semana pero no a diario",
    Alimentos == "Pescado"
  )
datatable(Alimentacion_pescado)
```
```{r, eval = TRUE, warning = FALSE}
Alimentacion_carne <- datos_Alimentacion %>%
  filter(
    Frecuencia == "3 o más veces a la semana pero no a diario",
    Alimentos == "Carne"
  )
datatable(Alimentacion_carne)
```

Tras estos dos **filter()** ahora se pueden hacer las gráficas correspondientes:

1. Gráfica Pescado
```{r, echo = TRUE}
Grafica_Pescado <- ggplot(Alimentacion_pescado, aes(x = Edad, y = value, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(
    title = "Porcentaje de Consumo de Pescado 3 o más Veces a la Semana, No Diario por Sexo y Rango de Edad",
    x = "Rango de Edad",
    y = "Porcentaje de Personas"
  ) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "salmon", "Ambos sexos" = "yellow")) +  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Grafica_Pescado
```

Es importante observar que la más mayor de este estudio es la que consume más cantidad de pescado y esto se nota claramente ya que en el rango de 18 a 24 años la gente que consume pescado 3 o más veces a la semana no supera el 40%, sin embargo, en el rango de 64 o más años la gente que hace el mismo tipo de consumo supera notablemente el 40%.

2. Gráfica Carne
```{r, echo = TRUE}
Grafica_Carne <- ggplot(Alimentacion_carne, aes(x = Edad, y = value, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(
    title = "Porcentaje de Consumo de Carne 3 o más Veces a la Semana, No Diario por Sexo y Rango de Edad",
    x = "Rango de Edad",
    y = "Porcentaje de Personas"
  ) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "salmon", "Ambos sexos" = "yellow")) +  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Grafica_Carne
```

Es importante observar que la más joven de este estudio es la que consume más cantidad de carne y esto se nota claramente ya que en el rango de 18 a 24 años la gente que consume carne 3 o más veces a la semana supera el 70%, sin embargo, en el rango de 64 o más años la gente que hace el mismo tipo de consumo representa el 60%.

Como conclusión, si se hace la una comparación de los resultados de ambas gráficas se puede ver que el consumo de carne 3 o más veces a la semana es mayor que el consumo de pescado.

#### **8.2.6 Relación de la alimentación de comida rápida una o dos veces por semana, por sexo y rangos de edad**
En este apartado vamos a analizar  la relación de comida rápida por la frecuencia indicada, por edad y sexo.

Para poder observar bien la gráfica hay que coger solo la frecuencia indicada y el alimento indicado para esto es necesario utilizar un filter, de la misma forma que antes.
```{r, eval = TRUE, warning = FALSE}
Alimentacion_rapida <- datos_Alimentacion %>%
  filter(
    Frecuencia == "1 o 2 veces a la semana",
  Alimentos == "Comida rápida"
  )
datatable(Alimentacion_rapida)
```

A partir de esta tabla, se muestra una gráfica donde se ve cómo varía con la edad el porcentaje de personas que consumen comida rápida.
```{r, echo = TRUE}
Grafica_CRapida <- ggplot(Alimentacion_rapida, aes(x = Edad, y = value, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(
    title = "Porcentaje de Consumo de comida rapida 1 o 2 veces a la Semana",
    x = "Rango de Edad",
    y = "Porcentaje de Personas"
  ) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "salmon", "Ambos sexos" = "yellow")) +  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Grafica_CRapida
```

### **8.3 Desempleo**

Comenzamos creando un dataframe para ver los datos de nuestro archivo de desempleo.

```{r , eval = TRUE, warning = FALSE}
Desempleo_frame <- as.data.frame(datos)
datatable(Desempleo_frame)
```

#### **8.3.1 Rangos de edades y corrección de carácteres extraños**
A continuación, realizamos un transmute para la agrupación de los diferentes rangos de edades y para corregir carácteres extraños como la ñ o las tíldes.
Después del transmtue, hacemos un mutate para crear una nueva columna con el nombre de Tiempo_de_búsqueda_de_empleo y eliminamos la anterior columna Tiempo.de.bÃºsqueda.de.empleo con un select.

```{r , eval = TRUE, warning = FALSE}
#Agrupación de los rangos de edades y correción de caraceteres extraños
Desempleo_agrup <- Desempleo_frame %>%
  transmute(
    Edad = case_when(
      Edad == "De 16 a 19 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 20 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 29 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 30 a 34 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 35 a 39 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 40 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 45 a 49 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 50 a 54 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 55 a 59 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 60 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 69 aÃ±os" ~ "65 o más",
      Edad == "70 y mÃ¡s aÃ±os" ~ "65 o más",
    ),
    Tiempo.de.bÃºsqueda.de.empleo = case_when(
      Tiempo.de.bÃºsqueda.de.empleo == "2 aÃ±os o mÃ¡s" ~ "2 años o más",
      Tiempo.de.bÃºsqueda.de.empleo == "Ya ha encontrado empleo" ~ "Ya ha encontrado empleo",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 mes a menos de 3 meses" ~ "De 1 mes a menos de 3 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 3 meses a menos de 6 meses" ~ "De 3 meses a menos de 6 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 6 meses a menos de 1 aÃ±o" ~ "De 6 meses a menos de 1 año",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 aÃ±o a menos de 2 aÃ±os" ~ "De 1 año a menos de 2 años",
      Tiempo.de.bÃºsqueda.de.empleo == "Total" ~ "Total",
      
    ),
    Periodo = Periodo,
    Tiempo.de.bÃºsqueda.de.empleo=Tiempo.de.bÃºsqueda.de.empleo,
    Edad = Edad,
    Sexo = Sexo,
    value = value, 
  )%>%
  #Cambio del nombre de la columna tiempo de búsqueda de empleo
  mutate(Desempleo_agrup,  Tiempo_de_búsqueda_de_empleo= Tiempo.de.bÃºsqueda.de.empleo)%>%
  select(-Tiempo.de.bÃºsqueda.de.empleo)
datatable(Desempleo_agrup)
```


#### **8.3.2 Eliminación de los valores NA**
Ahora se van a eliminar todos los valores NA que aparecian en las diferentes columnas.

```{r , eval = TRUE, warning = FALSE}
#Eliminar filas es la que salia el valor NA
Desempleo_no_NA <- Desempleo_agrup%>%
  drop_na(value, Tiempo_de_búsqueda_de_empleo, Edad, Periodo, Sexo)
datatable(Desempleo_no_NA)
```

#### **8.3.3 Eliminación de valores inecesarios y selección de los datos del 2021**
Por último vamos a eliminar los valores de ambos sexos y total que aparecian en las columnas de Sexo y de Tiempo_de_búsqueda_de_empleo y seleccionamos solo los datos del 2021 que son con los que vamos a trabajar.

```{r , eval = TRUE, warning = FALSE}
#Elimino los valores de ambos sexos y total, y selecciono solo los datos del 2021
Desempleo_data <-  Desempleo_no_NA %>%
  filter(
    Sexo != "Ambos sexos",                                  
    Tiempo_de_búsqueda_de_empleo != "Total",
    Periodo == "2021"                             
  )
datatable(Desempleo_data)
```


#### **8.3.4 Relación tiempo de búsqueda de empleo con IMC**
Realizamos un inner_join para relacionar los datos de las tablas de Desempleo_data con los datos de datos_IMC_df.

```{r , eval = TRUE, warning = FALSE}
#RELACIÓN TIMEPO BÚSQUEDA DE EMPLEO CON IMC
Desempleo_IMC <- inner_join( 
  Desempleo_data, 
  datos_IMC_df, 
  by = join_by(Edad, Sexo), 
)
```

Luego creamos un objeto llamado Desempleo_IMC_filtrado donde vamos nos vamos a quedar solo con los datos de obesidad y vamos a eliminar los valores "TOTAL".

```{r , eval = TRUE, warning = FALSE}
#Nos quedamos solo con la obesidad y eliminamos los valores total
Desempleo_IMC_filtrado<- Desempleo_IMC%>%
  drop_na()%>%
  filter(
    Masa.corporal.adultos=="Obesidad (IMC>=30 kg/m2)",
    Masa.corporal.adultos!="TOTAL",
    Nivel.de.estudios!="TOTAL"
  )
datatable(Desempleo_IMC_filtrado)
```


## **9. Resultados**
En este apartado se van a mostrar los resultados de los estudios realizados en los diferentes sets de datos. 

- En primer lugar, se mostrará el resultado del estudio de IMC. 

Para comenzar el análisis, hemos realizado una gráfica para analizar el porcentaje de personas que tienen un determinado peso.

```{r , echo = FALSE, warning=FALSE, message=FALSE}

Porcentaje_pesos<-ggplot(data = IMC_grafica1) + 
  geom_bar(
    mapping = aes(x = Masa.corporal.adultos, y=Porcentaje.personas,fill = Masa.corporal.adultos),
    stat = "identity",  # Para que se usen los valores de y que ya están calculados, si no da error porque intenta buscar categorías de masa.corporal.adultos
    show.legend = TRUE,
    width = 1 #Sin esto no salen bien cuadrados los diferentes triángulos, ya 
    #que se queda un espacio en blanco entre ellos, y al ponerlo salen pegados.
  ) + 
  scale_fill_manual( #Sin ponerlo manual los colores no salían como queríamos.
    values = c(
      "Peso insuficiente (IMC<18,5 kg/m2)" = "red",
      "Normopeso (18,5 kg/m2 <=IMC<25 kg/m2)" = "green",
      "Sobrepeso (25 kg/m2 <=IMC<30 kg/m2)" = "orange",
      "Obesidad (IMC>=30 kg/m2)" = "blue"
    )
  ) +
  labs(
    title="Porcentaje de pesos",
    x = "Masa corporal de adultos", 
    fill = "Masa corporal de adultos") +
  coord_polar()+
  theme(axis.text.x = element_blank()) # Para que no se muestre la leyenda 
  #dentro del gráfico, ya que no salen bien.

Porcentaje_pesos

```

En esta gráfica se puede apreciar que la mayor parte de la población tiene un peso normal, dentro de los rangos adecuados y más saludables. También se observa que hay un pequeño porcentaje de personas que tienen un índice de masa corporal menor que el recomendado. 

A pesar de esto, destaca que hay un porcentaje muy elevado de personas que tienen un peso mayor del recomendado (sobrepeso y obesidad), dentro de los cuales nosotros nos vamos a centrar en el análisis de la obesidad, que es mucho menor que el sobrepeso,pero que es mucho más preocupante en términos de salud. 

Seguido a esto, hemos realizado una gráfica que muestre la correlación que existe entre la obesidad, los niveles de estudio, la edad y el sexo.

```{r , echo = FALSE, warning=FALSE, message=FALSE}
Relaciones_obesidad<-ggplot(media_por_grupo, aes(x = Nivel.de.estudios, y = media_porcentaje, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") + #Con stat=identity hacemos 
  #que coja los datos ya calculados y con position dodge conseguimos que las 
  #columans de cada sexo salgan al lado y no una encima de otra
  facet_wrap(~ Edad) +  #Para que en el gráfico salgan datos para cada nivel de
  #la columna Edad
  labs(
    title = "Distribución por Nivel de Estudios, Edad y Sexo",
    x = "Nivel de estudios",
    y = "Porcentaje de personas"
  ) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "salmon")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, , hjust = 1)  # Rotar etiquetas del 
    #eje x para que se vean bien, ya que si no se superponen, y con hjust 
    #hacemos que dichas etiquetas empiecen justo debaje del gráfico ya que sino
    #salen dentro.
  )

Relaciones_obesidad
```

Viendo este resultado se pueden sacar diferentes conclusiones sobre que porcentaje de personas padecen obesidad relacionado con la edad, nivel de estudios y sexo.


- En segundo lugar se van a mostrar los resultados del estudio de desempleo.

A continuación, se muestra una gráfica donde mostramos una comparación entre el desempleo entre hombres y mujeres con en un grupo de edad desde los 18 a los 24 años durante el año 2021

```{r, echo = TRUE}
#GRÁFICA PARA COMPARAR EL DESEMPLEO ENTRE HOMBRES Y MUJERES EN 2021 POR GRUPO_EDAD
Desempleo_HM <- ggplot(Desempleo_data %>% filter(Edad == "De 18 a 24 años"), aes(x = Sexo, y = value, fill = Sexo)) +
  geom_bar(stat = "identity",  aes(fill=factor(Sexo))) +
  labs(title = "Comparación de Desempleo entre Hombres y Mujeres (18 a 24 años, 2021)", x = "Sexo", y = "Cantidad de Desempleo") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Desempleo_HM
```

Podemos observar que el desempleo es ligeramente mayor en los hombres de 18 a 24 años que en las mujeres.
Aun así el desempleo en ambos sexos es bastante elevado teniendo en cuenta que son datos de hace 3 años.
Vamos a ver ahora los datos de desempleo en un grupo de edad de los 25 a 64 años.

```{r, echo = TRUE}
#GRÁFICA PARA COMPARAR EL DESEMPLEO ENTRE HOMBRES Y MUJERES EN 2021 POR GRUPO_EDAD
Desempleo_HM <- ggplot(Desempleo_data %>% filter(Edad == "De 25 a 64 años"), aes(x = Sexo, y = value, fill = Sexo)) +
  geom_bar(stat = "identity",  aes(fill=factor(Sexo))) +
  labs(title = "Comparación de Desempleo entre Hombres y Mujeres (25 a 64 años, 2021)", x = "Sexo", y = "Cantidad de Desempleo") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Desempleo_HM
```

En esta gráfica el desempleo es algo mayor en las mujeres que en los hombres.
Aunque el desempleo sea mayor en hombres que en mujeres, el número de personas desempleadas sigue siendo bastante elevado y mucho mayor en comparación con el grupo de edad de los 18 a los 24 años.

Por último observaremos los datos para las personas mayores de 65 años.

```{r, echo = TRUE}
#GRÁFICA PARA COMPARAR EL DESEMPLEO ENTRE HOMBRES Y MUJERES EN 2021 POR GRUPO_EDAD
Desempleo_HM <- ggplot(Desempleo_data %>% filter(Edad == "65 o más"), aes(x = Sexo, y = value, fill = Sexo)) +
  geom_bar(stat = "identity",  aes(fill=factor(Sexo))) +
  labs(title = "Comparación de Desempleo entre Hombres y Mujeres (65 o más, 2021)", x = "Sexo", y = "Cantidad de Desempleo") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Desempleo_HM
```

En esta última gráfica podemos ver como hay mayor número de desempleo en hombres que en mujeres aunque la cantidad de personas desempleadas en muchisimo menor debido a la cercana edad de jubilación.

Observando las tres gráficas podemos concluir que el desempleo en estos últimos años está siendo un grave problema en la sociedad española sobre todo entre los 25 y 64 años, lo cual puede ser debido a distintos factores económicos, sociales y estrucuturales.


## **10. Conclusiones**

- Conclusión desempleo

Ahora vamos a observar la relación de imc entre hombres y mujeres según el timepo de desempleo.   

```{r, echo = TRUE}
#GRÁFICO QUE MUESTRA EL IMC DE HOMBRES Y MUJERES SEGÚN EL TIEMPO DE DESEMPLEO
Desempleo_obesidad <- ggplot(data = Desempleo_IMC_filtrado, aes(x = Tiempo_de_búsqueda_de_empleo, y = value, fill=Sexo)) +
  geom_bar(stat = "identity", position = "dodge", aes(fill=factor(Sexo))) +
  facet_wrap(~ Masa.corporal.adultos) +  # Dividir por grupos de edad
  labs(
    title = "Índice de masa corporal según el tiempo de desempleo",
    x = "Tiempo de desempleo", #creo que está mal
    y = "Personas en desempleo"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotar etiquetas del eje x para que se vean bien
  )
Desempleo_obesidad
```

Las personas que han estado desempleadas 2 años o más son las que más índice de masa corporal han ganadado, siendo mayor en las mujeres que en los hombres.
Tanto en las personas que están desempleadas durante 2 años o más, como las que están de 1 año a menos de 2 años, el imc es mayor en las mujeres. Mientras que en los tiempos cortos de desempleo el imc es mayor en los hombres.

A partir de este gráfico podemos concluir que en general el índice de masa corporal aumenta en las personas según el tiempo que han estado desempleadas ya que se puede observar como a medida que se reduce el tiempo que han estado desempleadas, tienen un menor índice de masa corporal.

## **11. Exportación de datos**
En este apartado proporcionaremos el código necesario para la exportación de las gráficas como imágenes en formato .jpeg, las cuales se encuentran dentro de la carpeta OUTPUT/Figures.

-Alimentación

-Desempleo

```{r, echo = TRUE}
#GRÁFICA PARA COMPARAR EL DESEMPLEO ENTRE HOMBRES Y MUJERES EN 2021 POR GRUPO_EDAD
ggsave(
  filename = "Desempleo_Hombres_Mujeres.jpeg",
  plot = Desempleo_HM ,
  #path = paste(getwd(), "/OUTPUT/Figures", sep = ""), # ruta absoluta
  path = "OUTPUT/Figures/Desempleo", # ruta relativa
  scale = 0.5,
  width = 40,
  height = 20,
  units = "cm",
  dpi = 320
)
```

```{r, echo = TRUE}
#GRÁFICO QUE MUESTRA EL IMC DE HOMBRES Y MUJERES SEGÚN EL TIEMPO DE DESEMPLEO
ggsave(
  filename = "Desempleo_obesidad.jpeg",
  plot = Desempleo_obesidad ,
  #path = paste(getwd(), "/OUTPUT/Figures", sep = ""), # ruta absoluta
  path = "OUTPUT/Figures/Desempleo", # ruta relativa
  scale = 0.5,
  width = 40,
  height = 20,
  units = "cm",
  dpi = 320
)
```

-IMC

## **12. Referencias**

