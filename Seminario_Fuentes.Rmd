---
title: "Relación de la obesidad con el desempleo y la alimentación"
author: "Diego González Sánchez, Pablo Santamaría Miguel, Juan Hernando Quintana"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **Índice**
  1. URL repositorio GitHub
  2. Datos utilizados
  3. Introducción 
  4. Objetivo general
  5. Paquetes utilizados
  6. Manipulación de datos
  7. Importación de datos
  8. Análisis de datos
  9. Resultados

## **1. URL repositorio GitHub**
https://github.com/Psm1015/Seminario_Fuentes.git

## **2. Datos utilizados**
En este apartado es donde se indican las URL´s que se van a utilizar durante el desarrollo de este proyecto. 

- [Datos obesidad](https://datos.gob.es/es/catalogo/ea0010587-indice-de-masa-corporal-poblacion-adulta-segun-sexo-grupo-de-edad-y-nivel-de-estudios-poblacion-de-18-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-01005-px1)

- [Datos desempleo](https://datos.gob.es/es/catalogo/ea0010587-parados-por-tiempo-de-busqueda-de-empleo-sexo-y-grupo-de-edad-epa-identificador-api-66002)

- [Datos alimentación](https://datos.gob.es/es/catalogo/ea0010587-patron-de-consumo-de-determinados-alimentos-segun-sexo-y-grupo-de-edad-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-05001-px1)

## **3. Introducción**
La obesidad es una enfermedad crónica común que se caracteriza por una acumulación anormal de grasa en el cuerpo, que no es saludable.

Aunque existen influencias genéticas, conductuales, metabólicas y hormonales en el peso corporal, la obesidad ocurre cuando se ingieren más calorías de las que se queman con las actividades diarias típicas y el ejercicio. El cuerpo almacena ese exceso de calorías en forma de grasa.

En este caso se realizará un estudio de como se ve afectada la obesidad en relación con el desempleo y la alimentación  respecto a la edad.

## **4. Objetivo general**
• Relación entre la obesidad, nivel de estudios, sexo y edad.

• Relación entre desempleo y obesidad.

• Relación entre alimentación y rangos de edad.

## **5. Paquetes utilizados**
Explícación de las distintas librerias utilizadas durante el desarrollo del proyecto:

1. library(dplyr)
Dplyr nos permite seleccionar, modificar, filtrar y agrupar los datos con los que hemos trabajado de forma sencilla.

```{r , eval = FALSE}
library(dplyr)
```

2. library(tidyverse)
Utilizamos tidyverse para importar, transformar y manipular los datos con los que trabajamos.

```{r , eval = FALSE}
library(tidyverse)
```

3. library(pxR)
Nos permite leer y manipular acrhivos que se encuentran en formato pc axis.

```{r , eval = FALSE}
library(pxR)
```

4. library(ggplot2)
Utilizamos esta librería para representar mediante gráficos los datos.

```{r , eval = FALSE}
library(ggplot2)
```

## **6. Manipulación de datos**
Los archivox .px son un formato estándar para almacenar datos estadísticos en forma de tablas multidimensionales.
Iniciálmente nuestros datos px no se encontraban en una codificacion UTF-8 y nos daba problemas al intentar visualizar los datos al inicio ya que contienen carácteres extraños como la 'ñ'.
Para solucionar nuestro problema convertimos la codificación de nuestros archivos, los cuales estaban en 'ISO-8859-1' a la codificación 'UTF-8'.
De esta forma ya podiamos visualizar y manipular nuestros datos.
Para ello realizamos lo siguiente (hemos tomado como ejemplo el archivo de Desempleo.px pero se realiza de la misma forma en todos los archivos .px):

Primero leemos nuestro archivo línea por línea en la codificación "ISO-8859-1"
```{r , eval = TRUE, warning = FALSE}
#Lectura del archivo línea por línea
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")
```

A continuación modificamos la codificación original de nuestro archivo a la codificación "UTF-8"
```{r , eval = TRUE, warning = FALSE}
#Modifica la codificación original del texto a la codificación UTF-8
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")
```

Ahora realizamos la creación del archivo temporal .px dentro de nuestro entorno
```{r , eval = TRUE, warning = FALSE}
#Creación del archivo temporal .px
archivo_utf8 <- tempfile(fileext = ".px")
```

Escribimos el contenido codificado en UTF-8 al archivo temporal
```{r , eval = TRUE, warning = FALSE}
#Se escribe el contenido codificado en UTF-8 al archivo temporal
writeLines(archivo_texto_utf8, archivo_utf8)
```

Y por último leemos este archivo temporal
Nota: comentamos la linea del read.px ya que nos da un error al generar el html
```{r , eval = TRUE, warning = FALSE}
# Lee el archivo temporal con read.px
#datos <- read.px(archivo_utf8)
```


## **7. Importación de datos**
En este apartado, se proporciona el código necesario para importar los archivos pc-axis de IMC, alimentación y desempleo

- IMC
```{r , eval = TRUE, warning = FALSE}
IMC <- readLines("INPUT/DATA/Indice-masa-corporal.px", encoding = "ISO-8859-1")
IMC_utf8 <- iconv(IMC, from = "ISO-8859-1", to = "UTF-8")
```

- Alimentación
```{r , eval = TRUE, warning = FALSE}
Alimentacion <- readLines("INPUT/DATA/Alimentacion.px", encoding = "ISO-8859-1")
Alimentacion_utf8 <- iconv(Alimentacion, from = "ISO-8859-1", to = "UTF-8")
```

- Desempleo
```{r , eval = FALSE, warning = FALSE}
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")
```

## **8. Análisis de datos**
En el archvido desempleo trabajaremos solo con los datos obtenidos del año 2021 en función del tiempo de búsqueda de empleo.

En el archivo alimentación analizaremos las distintas frecuencias con las que las personas del mismo rango de edades anterior consumen carne, pescado, dulces etc

En el archivo IMC (indice de masa corporal) estudiaremos el peso corporal de las personas según su nivel de estudios.

En todos ellos trabajaremos con unos rangos de edades de 8 a 24 años, 25 a 64 años y de 65 o más años.
Debido a como estaban estructurados los datos solo hemos tenido que establecer los rangos de edades en Alimentación y desempleo.

### **8.1 Alimentación**

Comenzamos creando un dataframe para ver los datos de nuestro archivo de desempleo

```{r , eval = FALSE, warning = FALSE}
Desempleo_frame <- as.data.frame(datos)
Desempleo_frame
```

Acontinuación, realizamos un transmute para la agrupación de los diferentes rangos de edades y para corregir carácteres extraños como la ñ o las tíldes.
Después del transmtue, hacemos un mutate para crear una nueva columna con el nombre de Tiempo_de_búsqueda_de_empleo y eliminamos la anterior columna Tiempo.de.bÃºsqueda.de.empleo con un select.

```{r , eval = FALSE, warning = FALSE}
#Agrupación de los rangos de edades y correción de caraceteres extraños
Desempleo_agrup <- Desempleo_frame %>%
  transmute(
    Edad = case_when(
      Edad == "De 16 a 19 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 20 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 29 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 30 a 34 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 35 a 39 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 40 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 45 a 49 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 50 a 54 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 55 a 59 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 60 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 69 aÃ±os" ~ "65 o más",
      Edad == "70 y mÃ¡s aÃ±os" ~ "65 o más",
    ),
    Tiempo.de.bÃºsqueda.de.empleo = case_when(
      Tiempo.de.bÃºsqueda.de.empleo == "2 aÃ±os o mÃ¡s" ~ "2 años o más",
      Tiempo.de.bÃºsqueda.de.empleo == "Ya ha encontrado empleo" ~ "Ya ha encontrado empleo",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 mes a menos de 3 meses" ~ "De 1 mes a menos de 3 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 3 meses a menos de 6 meses" ~ "De 3 meses a menos de 6 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 6 meses a menos de 1 aÃ±o" ~ "De 6 meses a menos de 1 año",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 aÃ±o a menos de 2 aÃ±os" ~ "De 1 año a menos de 2 años",
      Tiempo.de.bÃºsqueda.de.empleo == "Total" ~ "Total",
      
    ),
    Periodo = Periodo,
    Tiempo.de.bÃºsqueda.de.empleo=Tiempo.de.bÃºsqueda.de.empleo,
    Edad = Edad,
    Sexo = Sexo,
    value = value, 
  )%>%
  #Cambio del nombre de la columna tiempo de búsqueda de empleo
  mutate(Desempleo_agrup,  Tiempo_de_búsqueda_de_empleo= Tiempo.de.bÃºsqueda.de.empleo)%>%
  select(-Tiempo.de.bÃºsqueda.de.empleo)
```


Ahora se van a eliminar todos los valores NA que aparecian en las diferentes columnas.
```{r , eval = FALSE, warning = FALSE}
#Eliminar filas es la que salia el valor NA
Desempleo_no_NA <- Desempleo_agrup%>%
  drop_na(value, Tiempo_de_búsqueda_de_empleo, Edad, Periodo, Sexo)
Desempleo_no_NA
```


### **8.2 Desempleo**

Comenzamos creando un dataframe para ver los datos de nuestro archivo de desempleo.

```{r , eval = FALSE, warning = FALSE}
Desempleo_frame <- as.data.frame(datos)
Desempleo_frame
```

#### **8.2.1 Rangos de edades y corrección de carácteres extraños**
A continuación, realizamos un transmute para la agrupación de los diferentes rangos de edades y para corregir carácteres extraños como la ñ o las tíldes.
Después del transmtue, hacemos un mutate para crear una nueva columna con el nombre de Tiempo_de_búsqueda_de_empleo y eliminamos la anterior columna Tiempo.de.bÃºsqueda.de.empleo con un select.

```{r , eval = FALSE, warning = FALSE}
#Agrupación de los rangos de edades y correción de caraceteres extraños
Desempleo_agrup <- Desempleo_frame %>%
  transmute(
    Edad = case_when(
      Edad == "De 16 a 19 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 20 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 29 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 30 a 34 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 35 a 39 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 40 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 45 a 49 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 50 a 54 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 55 a 59 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 60 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 69 aÃ±os" ~ "65 o más",
      Edad == "70 y mÃ¡s aÃ±os" ~ "65 o más",
    ),
    Tiempo.de.bÃºsqueda.de.empleo = case_when(
      Tiempo.de.bÃºsqueda.de.empleo == "2 aÃ±os o mÃ¡s" ~ "2 años o más",
      Tiempo.de.bÃºsqueda.de.empleo == "Ya ha encontrado empleo" ~ "Ya ha encontrado empleo",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 mes a menos de 3 meses" ~ "De 1 mes a menos de 3 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 3 meses a menos de 6 meses" ~ "De 3 meses a menos de 6 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 6 meses a menos de 1 aÃ±o" ~ "De 6 meses a menos de 1 año",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 aÃ±o a menos de 2 aÃ±os" ~ "De 1 año a menos de 2 años",
      Tiempo.de.bÃºsqueda.de.empleo == "Total" ~ "Total",
      
    ),
    Periodo = Periodo,
    Tiempo.de.bÃºsqueda.de.empleo=Tiempo.de.bÃºsqueda.de.empleo,
    Edad = Edad,
    Sexo = Sexo,
    value = value, 
  )%>%
  #Cambio del nombre de la columna tiempo de búsqueda de empleo
  mutate(Desempleo_agrup,  Tiempo_de_búsqueda_de_empleo= Tiempo.de.bÃºsqueda.de.empleo)%>%
  select(-Tiempo.de.bÃºsqueda.de.empleo)
```


#### **8.2.2 Eliminación de los valores NA**
Ahora se van a eliminar todos los valores NA que aparecian en las diferentes columnas.

```{r , eval = FALSE, warning = FALSE}
#Eliminar filas es la que salia el valor NA
Desempleo_no_NA <- Desempleo_agrup%>%
  drop_na(value, Tiempo_de_búsqueda_de_empleo, Edad, Periodo, Sexo)
Desempleo_no_NA
```

#### **8.2.3 Eliminación de valores inecesarios y selección de los datos del 2021**
Por último vamos a eliminar los valores de ambos sexos y total que aparecian en las columnas de Sexo y de Tiempo_de_búsqueda_de_empleo y seleccionamos solo los datos del 2021 que son con los que vamos a trabajar.

```{r , eval = FALSE, warning = FALSE}
#Elimino los valores de ambos sexos y total, y selecciono solo los datos del 2021
Desempleo_data <-  Desempleo_no_NA %>%
  filter(
    Sexo != "Ambos sexos",                                  
    Tiempo_de_búsqueda_de_empleo != "Total",
    Periodo == "2021"                             
  )
```

#### **8.2.4 Comparación de desempleo entre hombres y mujeres en 2021**
Mostramos un gráfico en el que se compara el desempleo entre hombres y mujeres de un grupo de edad de 18 a 24 años durante el 2021.

```{r , eval = FALSE, warning = FALSE}
#Elimino los valores de ambos sexos y total, y selecciono solo los datos del 2021
ggplot(Desempleo_data %>% filter(Edad == "De 18 a 24 años"), aes(x = Sexo, y = value, fill = Sexo)) +
  geom_bar(stat = "identity",  aes(fill=factor(Sexo))) +
  labs(title = "Comparación de Desempleo entre Hombres y Mujeres (18 a 24 años, 2021)", x = "Sexo", y = "Cantidad de Desempleo") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

#### **8.2.5 Relación tiempo de búsqueda de empleo con IMC**
Realizamos un inner_join para relacionar los datos de las tablas de Desempleo_data con los datos de datos_IMC_df.

```{r , eval = FALSE, warning = FALSE}
#RELACIÓN TIMEPO BÚSQUEDA DE EMPLEO CON IMC
Desempleo_IMC <- inner_join( 
  Desempleo_data, 
  datos_IMC_df, 
  by = join_by(Edad, Sexo), 
)
```

Luego creamos un objeto llamado Desempleo_IMC_filtrado donde vamos nos vamos a quedar solo con los datos de obesidad y vamos a eliminar los valores "TOTAL".

```{r , eval = FALSE, warning = FALSE}
#Nos quedamos solo con la obesidad y eliminamos los valores total
Desempleo_IMC_filtrado<- Desempleo_IMC%>%
  drop_na()%>%
  filter(
    Masa.corporal.adultos=="Obesidad (IMC>=30 kg/m2)",
    Masa.corporal.adultos!="TOTAL",
    Nivel.de.estudios!="TOTAL"
    
  )
```

Y finalmente mostramos el gráfico resultante de esa relación.

```{r , eval = FALSE, warning = FALSE}
#GRÁFICO QUE MUESTRA EL IMC DE HOMBRES Y MUJERES SEGÚN EL TIEMPO DE DESEMPLEO
ggplot(data = Desmepleo_IMC_filtrado, aes(x = Tiempo_de_búsqueda_de_empleo, y = value, fill=Sexo)) +
  geom_bar(stat = "identity", position = "dodge", aes(fill=factor(Sexo))) +
  facet_wrap(~ Masa.corporal.adultos) +  # Dividir por grupos de edad
  labs(
    title = "Índice de masa corporal según el tiempo de desempleo",
    x = "Tiempo de desempleo", #creo que está mal
    y = "Personas en desempleo"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotar etiquetas del eje x para que se vean bien
  )
```

### **8.3 IMC**
Una vez tenemos los datos cargados, hemos tenido que realizar una serie de modificaciones para que sean aptos para trabajar con ellos.

Primero almacenamos los datos en un dataframe y modificamos los valores de las columnas que tenían caracteres especiales.

```{r , eval = FALSE, warning = FALSE}
DF_mal <- as.data.frame(datos_IMC)

DF <- DF_mal %>%
  transmute(
    Masa.corporal.adultos = Masa.corporal.adultos,
    Nivel.de.estudios = factor(case_when(
      Nivel.de.estudios == "TOTAL" ~ "TOTAL",
      Nivel.de.estudios == "BÃ¡sico e inferior" ~ "Básico e inferior",
      Nivel.de.estudios == "Intermedio" ~ "Intermedio",
      Nivel.de.estudios == "Superior" ~ "Superior",
    )),
    Edad = factor(case_when(
      Edad == "TOTAL" ~ "TOTAL",
      Edad == "De 18 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 y mÃ¡s aÃ±os" ~ "De 65 y más años",
    )),
    Sexo = Sexo,
    Porcentaje.personas = value
  )
```

Debido a que en las primera 20 filas había errores, se han eliminado estas.
```{r , eval = FALSE, warning = FALSE}
datos_IMC_df <- DF[-(1:20), ]
```

A partir de aquí hemos trabajado con unos datos generales y con unos datos específicos de obesidad.

```{r , eval = FALSE, warning = FALSE}
datos_obesidad <- datos_IMC_df %>%
  filter(
    Masa.corporal.adultos == "Obesidad (IMC>=30 kg/m2)",    
    Sexo != "Ambos sexos",                                  
    Edad != "TOTAL",                                        
    Nivel.de.estudios != "TOTAL"                            
  )
```

En estos de obesidad para evitar errores hemos tenido que eliminar los niveles que no usamos en las columnas.

```{r , eval = FALSE, warning = FALSE}
datos_obesidad$Sexo <- droplevels(datos_obesidad$Sexo)
datos_obesidad$Nivel.de.estudios <- droplevels(datos_obesidad$Nivel.de.estudios)
datos_obesidad$Edad <- droplevels(datos_obesidad$Edad)

```

## **9. Resultados**
En este apartado se van a mostrar los resultados de los estudios realizados en los diferentes sets de datos. En primer lugar, se mostrará el resultado del estudio de IMC. 

Para comenzar el análisis, hemos realizado una gráfica para analizar el porcentaje de personas que tienen un determinado peso.

```{r , echo = FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(pxR)
IMC <- readLines("INPUT/DATA/Indice-masa-corporal.px", encoding = "ISO-8859-1") #da un warning, ignorar por el momento

IMC_utf8 <- iconv(IMC, from = "ISO-8859-1", to = "UTF-8")

archivo_utf8 <- tempfile(fileext = ".px")
writeLines(IMC_utf8, archivo_utf8)

# Lee el archivo temporal con read.px
datos_IMC <- read.px(archivo_utf8)
DF_mal <- as.data.frame(datos_IMC)

DF <- DF_mal %>%
  transmute(
    Masa.corporal.adultos = Masa.corporal.adultos,
    Nivel.de.estudios = factor(case_when(
      Nivel.de.estudios == "TOTAL" ~ "TOTAL",
      Nivel.de.estudios == "BÃ¡sico e inferior" ~ "Básico e inferior",
      Nivel.de.estudios == "Intermedio" ~ "Intermedio",
      Nivel.de.estudios == "Superior" ~ "Superior",
    )),
    Edad = factor(case_when(
      Edad == "TOTAL" ~ "TOTAL",
      Edad == "De 18 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 y mÃ¡s aÃ±os" ~ "De 65 y más años",
    )),
    Sexo = Sexo,
    Porcentaje.personas = value
  )
datos_IMC_df <- DF[-(1:20), ]
datos_IMC_grafica3 <- datos_IMC_df %>%
  filter(
    Sexo != "Ambos sexos",                                  
    Edad != "TOTAL",                                        
    Nivel.de.estudios != "TOTAL",                           
    Masa.corporal.adultos != "TOTAL"
  )

#View(datos_IMC_grafica2)

#Eliminamos ahora los niveles que no utilizamos para que luego en la gráfica no aparezcan
datos_IMC_grafica3$Sexo <- droplevels(datos_IMC_grafica3$Sexo)
datos_IMC_grafica3$Edad <- droplevels(datos_IMC_grafica3$Edad)
datos_IMC_grafica3$Nivel.de.estudios <- droplevels(datos_IMC_grafica3$Nivel.de.estudios)
datos_IMC_grafica3$Masa.corporal.adultos <- droplevels(datos_IMC_grafica3$Masa.corporal.adultos)

IMC_grafica3_sin_niveles <- datos_IMC_grafica3 %>%
  group_by(Masa.corporal.adultos) %>%
  dplyr::summarise(Porcentaje.personas = mean(Porcentaje.personas, na.rm = TRUE))

#View(IMC_grafica3_sin_niveles)

Porcentaje_pesos<-ggplot(data = IMC_grafica3_sin_niveles) + 
  geom_bar(
    mapping = aes(x = Masa.corporal.adultos, y=Porcentaje.personas,fill = Masa.corporal.adultos),
    stat = "identity",  
    show.legend = TRUE,
    width = 1
  ) + 
  scale_fill_manual(
    values = c(
      "Peso insuficiente (IMC<18,5 kg/m2)" = "red",
      "Normopeso (18,5 kg/m2 <=IMC<25 kg/m2)" = "green",
      "Sobrepeso (25 kg/m2 <=IMC<30 kg/m2)" = "orange",
      "Obesidad (IMC>=30 kg/m2)" = "blue"
    )
  ) +
  theme(aspect.ratio = 1) +
  labs(
    title="Porcentaje de pesos",
    x = "Masa corporal de adultos", 
    fill = "Masa corporal de adultos") +
  coord_polar()+
  theme(axis.text.x = element_blank()) 
Porcentaje_pesos

```

En esta gráfica se puede apreciar que la mayor parte de la población tiene un peso normal, dentro de los rangos adecuados y más saludables. También se observa que hay un pequeño porcentaje de personas que tienen un índice de masa corporal menor que el recomendado. 

A pesar de esto, destaca que hay un porcentaje muy elevado de personas que tienen un peso mayor del recomendado (sobrepeso y obesidad), dentro de los cuales nosotros nos vamos a centrar en el análisis de la obesidad, que es mucho menor que el sobrepeso,pero que es mucho más preocupante en términos de salud. 


```{r , echo = FALSE}
---
title: "Relación de la obesidad con el desempleo y la alimentación"
author: "Diego González Sánchez, Pablo Santamaría Miguel, Juan Hernando Quintana"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **Índice**
  1. URL repositorio GitHub
  2. Datos utilizados
  3. Introducción 
  4. Objetivo general
  5. Paquetes utilizados
  6. Manipulación de datos
  7. Importación de datos
  8. Análisis de datos
  9. Resultados

## **1. URL repositorio GitHub**
https://github.com/Psm1015/Seminario_Fuentes.git

## **2. Datos utilizados**
En este apartado es donde se indican las URL´s que se van a utilizar durante el desarrollo de este proyecto. 

- [Datos obesidad](https://datos.gob.es/es/catalogo/ea0010587-indice-de-masa-corporal-poblacion-adulta-segun-sexo-grupo-de-edad-y-nivel-de-estudios-poblacion-de-18-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-01005-px1)

- [Datos desempleo](https://datos.gob.es/es/catalogo/ea0010587-parados-por-tiempo-de-busqueda-de-empleo-sexo-y-grupo-de-edad-epa-identificador-api-66002)

- [Datos alimentación](https://datos.gob.es/es/catalogo/ea0010587-patron-de-consumo-de-determinados-alimentos-segun-sexo-y-grupo-de-edad-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-05001-px1)

## **3. Introducción**
La obesidad es una enfermedad crónica común que se caracteriza por una acumulación anormal de grasa en el cuerpo, que no es saludable.

Aunque existen influencias genéticas, conductuales, metabólicas y hormonales en el peso corporal, la obesidad ocurre cuando se ingieren más calorías de las que se queman con las actividades diarias típicas y el ejercicio. El cuerpo almacena ese exceso de calorías en forma de grasa.

En este caso se realizará un estudio de como se ve afectada la obesidad en relación con el desempleo y la alimentación  respecto a la edad.

## **4. Objetivo general**
• Relación entre la obesidad, nivel de estudios, sexo y edad.

• Relación entre desempleo y obesidad.

• Relación entre alimentación y rangos de edad.

## **5. Paquetes utilizados**
Explícación de las distintas librerias utilizadas durante el desarrollo del proyecto:

1. library(dplyr)
Dplyr nos permite seleccionar, modificar, filtrar y agrupar los datos con los que hemos trabajado de forma sencilla.

```{r , eval = FALSE}
library(dplyr)
```

2. library(tidyverse)
Utilizamos tidyverse para importar, transformar y manipular los datos con los que trabajamos.

```{r , eval = FALSE}
library(tidyverse)
```

3. library(pxR)
Nos permite leer y manipular acrhivos que se encuentran en formato pc axis.

```{r , eval = FALSE}
library(pxR)
```

4. library(ggplot2)
Utilizamos esta librería para representar mediante gráficos los datos.

```{r , eval = FALSE}
library(ggplot2)
```

## **6. Manipulación de datos**
Los archivox .px son un formato estándar para almacenar datos estadísticos en forma de tablas multidimensionales.
Iniciálmente nuestros datos px no se encontraban en una codificacion UTF-8 y nos daba problemas al intentar visualizar los datos al inicio ya que contienen carácteres extraños como la 'ñ'.
Para solucionar nuestro problema convertimos la codificación de nuestros archivos, los cuales estaban en 'ISO-8859-1' a la codificación 'UTF-8'.
De esta forma ya podiamos visualizar y manipular nuestros datos.
Para ello realizamos lo siguiente (hemos tomado como ejemplo el archivo de Desempleo.px pero se realiza de la misma forma en todos los archivos .px):

Primero leemos nuestro archivo línea por línea en la codificación "ISO-8859-1"
```{r , eval = TRUE, warning = FALSE}
#Lectura del archivo línea por línea
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")
```

A continuación modificamos la codificación original de nuestro archivo a la codificación "UTF-8"
```{r , eval = TRUE, warning = FALSE}
#Modifica la codificación original del texto a la codificación UTF-8
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")
```

Ahora realizamos la creación del archivo temporal .px dentro de nuestro entorno
```{r , eval = TRUE, warning = FALSE}
#Creación del archivo temporal .px
archivo_utf8 <- tempfile(fileext = ".px")
```

Escribimos el contenido codificado en UTF-8 al archivo temporal
```{r , eval = TRUE, warning = FALSE}
#Se escribe el contenido codificado en UTF-8 al archivo temporal
writeLines(archivo_texto_utf8, archivo_utf8)
```

Y por último leemos este archivo temporal
Nota: comentamos la linea del read.px ya que nos da un error al generar el html
```{r , eval = TRUE, warning = FALSE}
# Lee el archivo temporal con read.px
#datos <- read.px(archivo_utf8)
```


## **7. Importación de datos**
En este apartado, se proporciona el código necesario para importar los archivos pc-axis de IMC, alimentación y desempleo

- IMC
```{r , eval = TRUE, warning = FALSE}
IMC <- readLines("INPUT/DATA/Indice-masa-corporal.px", encoding = "ISO-8859-1")
IMC_utf8 <- iconv(IMC, from = "ISO-8859-1", to = "UTF-8")
```

- Alimentación
```{r , eval = TRUE, warning = FALSE}
Alimentacion <- readLines("INPUT/DATA/Alimentacion.px", encoding = "ISO-8859-1")
Alimentacion_utf8 <- iconv(Alimentacion, from = "ISO-8859-1", to = "UTF-8")
```

- Desempleo
```{r , eval = FALSE, warning = FALSE}
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")
```

## **8. Análisis de datos**
En el archvido desempleo trabajaremos solo con los datos obtenidos del año 2021 en función del tiempo de búsqueda de empleo.

En el archivo alimentación analizaremos las distintas frecuencias con las que las personas del mismo rango de edades anterior consumen carne, pescado, dulces etc

En el archivo IMC (indice de masa corporal) estudiaremos el peso corporal de las personas según su nivel de estudios.

En todos ellos trabajaremos con unos rangos de edades de 8 a 24 años, 25 a 64 años y de 65 o más años.
Debido a como estaban estructurados los datos solo hemos tenido que establecer los rangos de edades en Alimentación y desempleo.

### **8.1 Alimentación**

Comenzamos creando un dataframe para ver los datos de nuestro archivo de desempleo

```{r , eval = FALSE, warning = FALSE}
Desempleo_frame <- as.data.frame(datos)
Desempleo_frame
```

Acontinuación, realizamos un transmute para la agrupación de los diferentes rangos de edades y para corregir carácteres extraños como la ñ o las tíldes.
Después del transmtue, hacemos un mutate para crear una nueva columna con el nombre de Tiempo_de_búsqueda_de_empleo y eliminamos la anterior columna Tiempo.de.bÃºsqueda.de.empleo con un select.

```{r , eval = FALSE, warning = FALSE}
#Agrupación de los rangos de edades y correción de caraceteres extraños
Desempleo_agrup <- Desempleo_frame %>%
  transmute(
    Edad = case_when(
      Edad == "De 16 a 19 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 20 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 29 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 30 a 34 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 35 a 39 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 40 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 45 a 49 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 50 a 54 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 55 a 59 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 60 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 69 aÃ±os" ~ "65 o más",
      Edad == "70 y mÃ¡s aÃ±os" ~ "65 o más",
    ),
    Tiempo.de.bÃºsqueda.de.empleo = case_when(
      Tiempo.de.bÃºsqueda.de.empleo == "2 aÃ±os o mÃ¡s" ~ "2 años o más",
      Tiempo.de.bÃºsqueda.de.empleo == "Ya ha encontrado empleo" ~ "Ya ha encontrado empleo",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 mes a menos de 3 meses" ~ "De 1 mes a menos de 3 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 3 meses a menos de 6 meses" ~ "De 3 meses a menos de 6 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 6 meses a menos de 1 aÃ±o" ~ "De 6 meses a menos de 1 año",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 aÃ±o a menos de 2 aÃ±os" ~ "De 1 año a menos de 2 años",
      Tiempo.de.bÃºsqueda.de.empleo == "Total" ~ "Total",
      
    ),
    Periodo = Periodo,
    Tiempo.de.bÃºsqueda.de.empleo=Tiempo.de.bÃºsqueda.de.empleo,
    Edad = Edad,
    Sexo = Sexo,
    value = value, 
  )%>%
  #Cambio del nombre de la columna tiempo de búsqueda de empleo
  mutate(Desempleo_agrup,  Tiempo_de_búsqueda_de_empleo= Tiempo.de.bÃºsqueda.de.empleo)%>%
  select(-Tiempo.de.bÃºsqueda.de.empleo)
```


Ahora se van a eliminar todos los valores NA que aparecian en las diferentes columnas.
```{r , eval = FALSE, warning = FALSE}
#Eliminar filas es la que salia el valor NA
Desempleo_no_NA <- Desempleo_agrup%>%
  drop_na(value, Tiempo_de_búsqueda_de_empleo, Edad, Periodo, Sexo)
Desempleo_no_NA
```


### **8.2 Desempleo**

Comenzamos creando un dataframe para ver los datos de nuestro archivo de desempleo.

```{r , eval = FALSE, warning = FALSE}
Desempleo_frame <- as.data.frame(datos)
Desempleo_frame
```

#### **8.2.1 Rangos de edades y corrección de carácteres extraños**
A continuación, realizamos un transmute para la agrupación de los diferentes rangos de edades y para corregir carácteres extraños como la ñ o las tíldes.
Después del transmtue, hacemos un mutate para crear una nueva columna con el nombre de Tiempo_de_búsqueda_de_empleo y eliminamos la anterior columna Tiempo.de.bÃºsqueda.de.empleo con un select.

```{r , eval = FALSE, warning = FALSE}
#Agrupación de los rangos de edades y correción de caraceteres extraños
Desempleo_agrup <- Desempleo_frame %>%
  transmute(
    Edad = case_when(
      Edad == "De 16 a 19 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 20 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 29 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 30 a 34 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 35 a 39 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 40 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 45 a 49 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 50 a 54 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 55 a 59 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 60 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 69 aÃ±os" ~ "65 o más",
      Edad == "70 y mÃ¡s aÃ±os" ~ "65 o más",
    ),
    Tiempo.de.bÃºsqueda.de.empleo = case_when(
      Tiempo.de.bÃºsqueda.de.empleo == "2 aÃ±os o mÃ¡s" ~ "2 años o más",
      Tiempo.de.bÃºsqueda.de.empleo == "Ya ha encontrado empleo" ~ "Ya ha encontrado empleo",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 mes a menos de 3 meses" ~ "De 1 mes a menos de 3 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 3 meses a menos de 6 meses" ~ "De 3 meses a menos de 6 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 6 meses a menos de 1 aÃ±o" ~ "De 6 meses a menos de 1 año",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 aÃ±o a menos de 2 aÃ±os" ~ "De 1 año a menos de 2 años",
      Tiempo.de.bÃºsqueda.de.empleo == "Total" ~ "Total",
      
    ),
    Periodo = Periodo,
    Tiempo.de.bÃºsqueda.de.empleo=Tiempo.de.bÃºsqueda.de.empleo,
    Edad = Edad,
    Sexo = Sexo,
    value = value, 
  )%>%
  #Cambio del nombre de la columna tiempo de búsqueda de empleo
  mutate(Desempleo_agrup,  Tiempo_de_búsqueda_de_empleo= Tiempo.de.bÃºsqueda.de.empleo)%>%
  select(-Tiempo.de.bÃºsqueda.de.empleo)
```


#### **8.2.2 Eliminación de los valores NA**
Ahora se van a eliminar todos los valores NA que aparecian en las diferentes columnas.

```{r , eval = FALSE, warning = FALSE}
#Eliminar filas es la que salia el valor NA
Desempleo_no_NA <- Desempleo_agrup%>%
  drop_na(value, Tiempo_de_búsqueda_de_empleo, Edad, Periodo, Sexo)
Desempleo_no_NA
```

#### **8.2.3 Eliminación de valores inecesarios y selección de los datos del 2021**
Por último vamos a eliminar los valores de ambos sexos y total que aparecian en las columnas de Sexo y de Tiempo_de_búsqueda_de_empleo y seleccionamos solo los datos del 2021 que son con los que vamos a trabajar.

```{r , eval = FALSE, warning = FALSE}
#Elimino los valores de ambos sexos y total, y selecciono solo los datos del 2021
Desempleo_data <-  Desempleo_no_NA %>%
  filter(
    Sexo != "Ambos sexos",                                  
    Tiempo_de_búsqueda_de_empleo != "Total",
    Periodo == "2021"                             
  )
```

#### **8.2.4 Comparación de desempleo entre hombres y mujeres en 2021**
Mostramos un gráfico en el que se compara el desempleo entre hombres y mujeres de un grupo de edad de 18 a 24 años durante el 2021.

```{r , echo = FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(pxR)


#Lectura del archivo línea por línea
archivo_texto <- readLines("INPUT/DATA/Desempleo.px", encoding = "ISO-8859-1")

#Modifica la codificación original del texto a la codificación UTF-8
archivo_texto_utf8 <- iconv(archivo_texto, from = "ISO-8859-1", to = "UTF-8")

#Creación del archivo temporal .px
archivo_utf8 <- tempfile(fileext = ".px")

#Se escribe el contenido codificado en UTF-8 al archivo temporal
writeLines(archivo_texto_utf8, archivo_utf8)

# Lee el archivo temporal con read.px
datos <- read.px(archivo_utf8)


Desempleo_frame <- as.data.frame(datos)


#Agrupación de los rangos de edades y correción de caraceteres extraños
Desempleo_agrup <- Desempleo_frame %>%
  transmute(
    Edad = case_when(
      Edad == "De 16 a 19 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 20 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 29 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 30 a 34 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 35 a 39 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 40 a 44 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 45 a 49 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 50 a 54 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 55 a 59 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 60 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 a 69 aÃ±os" ~ "65 o más",
      Edad == "70 y mÃ¡s aÃ±os" ~ "65 o más",
    ),
    Tiempo.de.bÃºsqueda.de.empleo = case_when(
      Tiempo.de.bÃºsqueda.de.empleo == "2 aÃ±os o mÃ¡s" ~ "2 años o más",
      Tiempo.de.bÃºsqueda.de.empleo == "Ya ha encontrado empleo" ~ "Ya ha encontrado empleo",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 mes a menos de 3 meses" ~ "De 1 mes a menos de 3 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 3 meses a menos de 6 meses" ~ "De 3 meses a menos de 6 meses",
      Tiempo.de.bÃºsqueda.de.empleo == "De 6 meses a menos de 1 aÃ±o" ~ "De 6 meses a menos de 1 año",
      Tiempo.de.bÃºsqueda.de.empleo == "De 1 aÃ±o a menos de 2 aÃ±os" ~ "De 1 año a menos de 2 años",
      Tiempo.de.bÃºsqueda.de.empleo == "Total" ~ "Total",
      
    ),
    Periodo = Periodo,
    Tiempo.de.bÃºsqueda.de.empleo=Tiempo.de.bÃºsqueda.de.empleo,
    Edad = Edad,
    Sexo = Sexo,
    value = value, 
  )%>%
  #Cambio del nombre de la columna tiempo de búsqueda de empleo
  mutate(Desempleo_agrup,  Tiempo_de_búsqueda_de_empleo= Tiempo.de.bÃºsqueda.de.empleo)%>%
  select(-Tiempo.de.bÃºsqueda.de.empleo)


#Eliminar filas es la que salia el valor NA
Desempleo_no_NA <- Desempleo_agrup%>%
  drop_na(value, Tiempo_de_búsqueda_de_empleo, Edad, Periodo, Sexo)



#Elimino los valores de ambos sexos y total, y selecciono solo los datos del 2021
Desempleo_data <-  Desempleo_no_NA %>%
  filter(
    Sexo != "Ambos sexos",                                  
    Tiempo_de_búsqueda_de_empleo != "Total",
    Periodo == "2021"                             
  )


#GRÁFICAS
library(ggplot2)

#GRÁFICA PARA COMPARAR EL DESEMPLEO ENTRE HOMBRES Y MUJERES EN 2021 POR GRUPO_EDAD
Desempleo_HM <- ggplot(Desempleo_data %>% filter(Edad == "De 18 a 24 años"), aes(x = Sexo, y = value, fill = Sexo)) +
  geom_bar(stat = "identity",  aes(fill=factor(Sexo))) +
  labs(title = "Comparación de Desempleo entre Hombres y Mujeres (18 a 24 años, 2021)", x = "Sexo", y = "Cantidad de Desempleo") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
Desempleo_HM
```

#### **8.2.5 Relación tiempo de búsqueda de empleo con IMC**
Realizamos un inner_join para relacionar los datos de las tablas de Desempleo_data con los datos de datos_IMC_df.

```{r , eval = FALSE, warning = FALSE}
#RELACIÓN TIMEPO BÚSQUEDA DE EMPLEO CON IMC
Desempleo_IMC <- inner_join( 
  Desempleo_data, 
  datos_IMC_df, 
  by = join_by(Edad, Sexo), 
)
```

Luego creamos un objeto llamado Desempleo_IMC_filtrado donde vamos nos vamos a quedar solo con los datos de obesidad y vamos a eliminar los valores "TOTAL".

```{r , eval = FALSE, warning = FALSE}
#Nos quedamos solo con la obesidad y eliminamos los valores total
Desempleo_IMC_filtrado<- Desempleo_IMC%>%
  drop_na()%>%
  filter(
    Masa.corporal.adultos=="Obesidad (IMC>=30 kg/m2)",
    Masa.corporal.adultos!="TOTAL",
    Nivel.de.estudios!="TOTAL"
    
  )
```

Y finalmente mostramos el gráfico resultante de esa relación.

```{r , eval = FALSE, warning = FALSE}
#GRÁFICO QUE MUESTRA EL IMC DE HOMBRES Y MUJERES SEGÚN EL TIEMPO DE DESEMPLEO
Desempleo_obesidad <- ggplot(data = Desmepleo_IMC_filtrado, aes(x = Tiempo_de_búsqueda_de_empleo, y = value, fill=Sexo)) +
  geom_bar(stat = "identity", position = "dodge", aes(fill=factor(Sexo))) +
  facet_wrap(~ Masa.corporal.adultos) +  # Dividir por grupos de edad
  labs(
    title = "Índice de masa corporal según el tiempo de desempleo",
    x = "Tiempo de desempleo", #creo que está mal
    y = "Personas en desempleo"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotar etiquetas del eje x para que se vean bien
  )
Desempleo_obesidad
```

### **8.3 IMC**
Una vez tenemos los datos cargados, hemos tenido que realizar una serie de modificaciones para que sean aptos para trabajar con ellos.

Primero almacenamos los datos en un dataframe y modificamos los valores de las columnas que tenían caracteres especiales.

```{r , eval = FALSE, warning = FALSE}
DF_mal <- as.data.frame(datos_IMC)

DF <- DF_mal %>%
  transmute(
    Masa.corporal.adultos = Masa.corporal.adultos,
    Nivel.de.estudios = factor(case_when(
      Nivel.de.estudios == "TOTAL" ~ "TOTAL",
      Nivel.de.estudios == "BÃ¡sico e inferior" ~ "Básico e inferior",
      Nivel.de.estudios == "Intermedio" ~ "Intermedio",
      Nivel.de.estudios == "Superior" ~ "Superior",
    )),
    Edad = factor(case_when(
      Edad == "TOTAL" ~ "TOTAL",
      Edad == "De 18 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 y mÃ¡s aÃ±os" ~ "De 65 y más años",
    )),
    Sexo = Sexo,
    Porcentaje.personas = value
  )
```

Debido a que en las primera 20 filas había errores, se han eliminado estas.
```{r , eval = FALSE, warning = FALSE}
datos_IMC_df <- DF[-(1:20), ]
```

A partir de aquí hemos trabajado con unos datos generales y con unos datos específicos de obesidad.

```{r , eval = FALSE, warning = FALSE}
datos_obesidad <- datos_IMC_df %>%
  filter(
    Masa.corporal.adultos == "Obesidad (IMC>=30 kg/m2)",    
    Sexo != "Ambos sexos",                                  
    Edad != "TOTAL",                                        
    Nivel.de.estudios != "TOTAL"                            
  )
```

En estos de obesidad para evitar errores hemos tenido que eliminar los niveles que no usamos en las columnas.

```{r , eval = FALSE, warning = FALSE}
datos_obesidad$Sexo <- droplevels(datos_obesidad$Sexo)
datos_obesidad$Nivel.de.estudios <- droplevels(datos_obesidad$Nivel.de.estudios)
datos_obesidad$Edad <- droplevels(datos_obesidad$Edad)

```

## **9. Resultados**
En este apartado se van a mostrar los resultados de lss estudios realizados en los diferentes sets de datos. En primer lugar, se mostrará el resultado del estudio de IMC. 

En primer lugar hemos realizado una gráfica para analizar el porcentaje de personas que tienen un determinado peso.

```{r , echo = FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(pxR)
IMC <- readLines("INPUT/DATA/Indice-masa-corporal.px", encoding = "ISO-8859-1") #da un warning, ignorar por el momento

IMC_utf8 <- iconv(IMC, from = "ISO-8859-1", to = "UTF-8")

archivo_utf8 <- tempfile(fileext = ".px")
writeLines(IMC_utf8, archivo_utf8)

# Lee el archivo temporal con read.px
datos_IMC <- read.px(archivo_utf8)
DF_mal <- as.data.frame(datos_IMC)

DF <- DF_mal %>%
  transmute(
    Masa.corporal.adultos = Masa.corporal.adultos,
    Nivel.de.estudios = factor(case_when(
      Nivel.de.estudios == "TOTAL" ~ "TOTAL",
      Nivel.de.estudios == "BÃ¡sico e inferior" ~ "Básico e inferior",
      Nivel.de.estudios == "Intermedio" ~ "Intermedio",
      Nivel.de.estudios == "Superior" ~ "Superior",
    )),
    Edad = factor(case_when(
      Edad == "TOTAL" ~ "TOTAL",
      Edad == "De 18 a 24 aÃ±os" ~ "De 18 a 24 años",
      Edad == "De 25 a 64 aÃ±os" ~ "De 25 a 64 años",
      Edad == "De 65 y mÃ¡s aÃ±os" ~ "De 65 y más años",
    )),
    Sexo = Sexo,
    Porcentaje.personas = value
  )
datos_IMC_df <- DF[-(1:20), ]
datos_IMC_grafica3 <- datos_IMC_df %>%
  filter(
    Sexo != "Ambos sexos",                                  
    Edad != "TOTAL",                                        
    Nivel.de.estudios != "TOTAL",                           
    Masa.corporal.adultos != "TOTAL"
  )

#View(datos_IMC_grafica2)

#Eliminamos ahora los niveles que no utilizamos para que luego en la gráfica no aparezcan
datos_IMC_grafica3$Sexo <- droplevels(datos_IMC_grafica3$Sexo)
datos_IMC_grafica3$Edad <- droplevels(datos_IMC_grafica3$Edad)
datos_IMC_grafica3$Nivel.de.estudios <- droplevels(datos_IMC_grafica3$Nivel.de.estudios)
datos_IMC_grafica3$Masa.corporal.adultos <- droplevels(datos_IMC_grafica3$Masa.corporal.adultos)

IMC_grafica3_sin_niveles <- datos_IMC_grafica3 %>%
  group_by(Masa.corporal.adultos) %>%
  dplyr::summarise(Porcentaje.personas = mean(Porcentaje.personas, na.rm = TRUE))


Porcentaje_pesos<-ggplot(data = IMC_grafica3_sin_niveles) + 
  geom_bar(
    mapping = aes(x = Masa.corporal.adultos, y=Porcentaje.personas,fill = Masa.corporal.adultos),
    stat = "identity",  
    show.legend = TRUE,
    width = 1
  ) + 
  scale_fill_manual(
    values = c(
      "Peso insuficiente (IMC<18,5 kg/m2)" = "red",
      "Normopeso (18,5 kg/m2 <=IMC<25 kg/m2)" = "green",
      "Sobrepeso (25 kg/m2 <=IMC<30 kg/m2)" = "orange",
      "Obesidad (IMC>=30 kg/m2)" = "blue"
    )
  ) +
  theme(aspect.ratio = 1) +
  labs(
    title="Porcentaje de pesos",
    x = "Masa corporal de adultos", 
    fill = "Masa corporal de adultos") +
  coord_polar()+
  theme(axis.text.x = element_blank()) 
Porcentaje_pesos

```

En esta gráfica se puede apreciar que la mayor parte de la población tiene un peso normal, dentro de los rangos adecuados y más saludables. También se observa que hay un pequeño porcentaje de personas que tienen un índice de masa corporal menor que el recomendado. 

A pesar de esto, destaca que hay un porcentaje muy elevado de personas que tienen un peso mayor del recomendado (sobrepeso y obesidad), dentro de los cuales nosotros nos vamos a centrar en el análisis de la obesidad, que es mucho menor que el sobrepeso,pero que es mucho más preocupante en términos de salud. 

La siguiente gráfica nos va a mostrar la relación que existe entre la obesidad, la edad, el nivel de estudios y el sexo.


```{r , echo = FALSE}
media_por_grupo <- datos_obesidad %>%
  group_by(Nivel.de.estudios, Sexo, Edad) %>%
  dplyr::summarise(media_porcentaje = mean(Porcentaje.personas, na.rm = TRUE))


Relaciones_obesidad<-ggplot(media_por_grupo, aes(x = Nivel.de.estudios, y = media_porcentaje, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Edad) +  # Dividir por grupos de edad
  labs(
    title = "Distribución por Nivel de Estudios, Edad y Sexo",
    x = "Nivel de estudios",
    y = "Porcentaje de personas"
  ) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "salmon")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1) 
  )

Relaciones_obesidad
```

Viendo este resultado se pueden sacar diferentes conclusiones sobre que porcentaje de personas padecen obesidad relacionado con la edad, nivel de estudios y sexo.

```

Viendo este resultado se pueden sacar diferentes conclusiones sobre que porcentaje de personas padecen obesidad relacionado con la edad, nivel de estudios y sexo.

